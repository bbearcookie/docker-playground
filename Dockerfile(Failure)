# Node 20 버전을 기반으로 파일을 빌드할 이미지 (alpine은 경량화 버전)
FROM node:20-alpine as base

# 이미지에 파일 복사
COPY package.json pnpm-lock.yaml ./
COPY src ./src
COPY tsconfig.json ./tsconfig.json

# 패키지 설치 및 빌드
RUN corepack enable && \
  pnpm install && \
  pnpm build

# 빌드된 파일을 실행할 이미지
# (이미지 크기 최소화를 위해 빌드와 실행을 분리하는 Multi-Stage Build를 적용하려고 했는데, path-alias를 위해서는 module-alias 패키지가 필요한 문제때문에 시도 후 실패.)
FROM node:20-alpine

RUN npm install -g pm2 module-alias

EXPOSE 5010
CMD ["node", "-r", "module-alias/register", "dist/app.js"]

COPY --from=base node_modules ./node_modules
COPY --from=base dist ./dist